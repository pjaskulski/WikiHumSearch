<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiHumSearch</title>
    <link rel="icon" href="/static/favicon.png" type="image/png">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; line-height: 1.6; }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        h1 { text-align: center; color: #0c4a6e; }
        .search-form { display: flex; gap: 10px; margin-bottom: 1rem; }
        #search-input { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        button { padding: 12px 20px; background-color: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #0284c7; }

        .help-button {
            position: absolute;
            top: 2rem;
            right: 2rem;
            padding: 8px 16px;
            background-color: #167c2f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .help-button:hover {
            background-color: #5a6268;
        }

        .disclaimer-text {
            font-size: 0.9em;
            color: #4a5568;
            background-color: #f0f4f8;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 2rem;
        }

        .result-item { border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 10px; border-radius: 6px; background-color: #fafafa; }
        .result-item h3 { margin: 0 0 5px 0; color: #075985; }
        .info {
            font-size: 0.9em;
            font-style: italic;
            color: #555;
            margin-top: -5px;
            margin-bottom: 8px;
        }
        .smallinfo {
            font-size: 0.7em;
            color: #555;
            margin-top: -5px;
            margin-bottom: 6px;
        }
        .typy-container {
            font-size: 0.9em;
            font-style: italic;
            color: #555;
            margin-top: -2px;
        }
        .typy-tag {
            display: inline-block;
            font-size: 0.9em;
            font-style: italic;
            color: #555;
            margin-right: 6px;
        }
        .result-item p { margin: 0; }

        #results-info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #666;
            font-style: italic;
            margin-bottom: 1rem;
        }
        .export-button {
            display: inline-block;
            padding: 6px 12px;
            background-color: #0c4a6e;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-style: normal;
            font-size: 14px;
            font-weight: bold;
        }
        .export-button:hover {
            background-color: #075985;
        }

        #reset-button {
            background-color: #6c757d;
        }
        #reset-button:hover {
            background-color: #5a6268;
        }

        /* Styl dla przycisku Load More */
        #load-more-container {
            text-align: center;
            margin-top: 20px;
            display: none; /* Domy≈õlnie ukryty */
        }
        #load-more-button {
            background-color: #fff;
            color: #0ea5e9;
            border: 2px solid #0ea5e9;
        }
        #load-more-button:hover {
            background-color: #f0f9ff;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
        }
        #help-modal .modal-content {
            max-width: 750px;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
        }
        .modal-text-content {
            max-height: 400px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            margin-bottom: 10px;
        }
        .entry-nazwa-link {
            cursor: pointer;
            color: #075985;
            text-decoration: underline;
        }
        .entry-nazwa-link:hover {
            color: #0ea5e9;
        }
    </style>
</head>
<body>

    <div class="container">
        <button id="help-button" class="help-button">Pomoc</button>

        <h1>üèõÔ∏è WikiHumSearch - wyszukiwanie wektorowe</h1>

        <form id="search-form">
            <div class="search-form">
                <input type="text" id="search-input" placeholder="np. 'cz≈Çowiek militaria'...">
                <button type="submit">Szukaj</button>
                <button type="button" id="reset-button">Wyczy≈õƒá</button>
            </div>
        </form>

        <div class="disclaimer-text">
            * Mechanizm wyszukiwania znajduje siƒô obecnie na wczesnym etapie test√≥w, wyniki mogƒÖ byƒá niekompletne lub niedok≈Çadne. Zapoznaj siƒô z instrukcjami (Pomoc).
        </div>

        <div id="results-info-container">
            <span id="results-info-text"></span>
            <a href="#" id="export-link" class="export-button" style="display: none;">Eksportuj (wszystkie widoczne)</a>
        </div>

        <div id="results"></div>

        <div id="load-more-container">
            <button id="load-more-button">Za≈Çaduj wiƒôcej wynik√≥w</button>
        </div>
    </div>

    <div id="entry-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-entry-button">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-help-button">&times;</span>
            <h2>Pomoc</h2>
            <p>Witaj w wyszukiwarce wektorowej WikiHumSearch!</p>
            <p><strong>Jak szukaƒá:</strong></p>
            <ul style="margin-top: -10px;">
                <li>Wpisz w pole wyszukiwania interesujƒÖcƒÖ Ciƒô frazƒô np. "matematycy", "cz≈Çowiek militaria", "Stanis≈Çaw August Poniatowski" (bez cudzys≈Çow√≥w!).</li>
                <li>Naci≈õnij "Szukaj" lub klawisz Enter.</li>
                <li>Wyszukiwarka korzysta z wyszukiwania hybrydowego, ≈ÇƒÖczƒÖc s≈Çowa kluczowe (10%) z wyszukiwaniem wektorowym - semantycznym (90%), aby daƒá jak najlepsze wyniki.</li>
                <li>Mechanizm nie odpowiada na pytania, zwraca jedynie wyniki o zbli≈ºonym znaczeniu do zapytania, nie zwraca te≈º¬†kompletnej, precyzyjnej listy informacji - do takich zapyta≈Ñ u≈ºyj SPARQL.</li>
            </ul>
            <p><strong>Wyniki:</strong></p>
            <ul style="margin-top: -10px;">
                <li>Kliknij na tytu≈Ç (label) wyniku, aby zobaczyƒá wiƒôcej szczeg√≥≈Ç√≥w w osobnym oknie ( link do WikiHum, listƒô w≈Ça≈õciwo≈õci, wsp√≥≈Çrzƒôdne geograficzne dla miejscowo≈õci).</li>
                <li>Je≈õli wynik√≥w jest du≈ºo, na dole listy pojawi siƒô przycisk <strong>"Za≈Çaduj wiƒôcej wynik√≥w"</strong>.</li>
                <li>U≈ºyj przycisku "Wyczy≈õƒá", aby zresetowaƒá widok.</li>
            </ul>
            <p><strong>Eksport:</strong></p>
            <ul style="margin-top: -10px;">
                <li>Przycisk "Eksportuj" pobierze wszystkie aktualnie za≈Çadowane (widoczne na ekranie) wyniki do pliku CSV.</li>
            </ul>
            <p><strong>Dodatkowe wyja≈õnienia:</strong><br>
                Cel mechanizmu wyszukiwania semantycznego jest taki sam jak projektu <a href="https://www.wikidata.org/wiki/Wikidata:Embedding_Project" target="_blank">Wikidata:Embedding Project</a> (Wikidata Vector Database):
"Wyszukiwanie wektorowe jest przeznaczone przede wszystkim do eksploracji i odkrywania. Pomaga u≈ºytkownikom i badaczom identyfikowaƒá powiƒÖzane elementy, kt√≥re mogƒÖ nie pojawiƒá siƒô w wynikach tradycyjnego wyszukiwania s≈Ç√≥w kluczowych. Wyniki nie majƒÖ s≈Çu≈ºyƒá jako bezpo≈õrednie odpowiedzi, ale jako punkt wyj≈õcia do dalszych bada≈Ñ i analiz."<br>
            </p>
        </div>
    </div>

    <script>
        const form = document.getElementById('search-form');
        const input = document.getElementById('search-input');
        const resultsContainer = document.getElementById('results');
        const resetButton = document.getElementById('reset-button');
        const resultsInfoText = document.getElementById('results-info-text');
        const exportLink = document.getElementById('export-link');

        // Elementy paginacji
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreButton = document.getElementById('load-more-button');

        // Zmienne stanu
        let allDisplayedHits = []; // To co widzi u≈ºytkownik (do eksportu CSV)
        let loadedIds = new Set(); // Zbi√≥r ID, by unikaƒá duplikat√≥w

        let pendingBuffer = [];    // BUFOR: Wyniki pobrane, unikalne, ale jeszcze nie wy≈õwietlone
        let serverOffset = 0;      // Surowy offset dla serwera (ile przetworzy≈Ç silnik)
        let isEndOfData = false;   // znacznik czy serwer zwr√≥ci≈Ç ju≈º wszystko?

        const DISPLAY_BATCH_SIZE = 20; // Ile wynik√≥w dodaƒá na raz
        const FETCH_SIZE = 40;         // Ile wynik√≥w pobraƒá z serwera (wiƒôcej ni≈º¬†DISPLAY_BATCH_SIZE, ≈ºeby pokryƒá duplikaty)

        let estimatedTotalHits = 0;
        let lastQuery = "";

        // Modalne okna
        const modal = document.getElementById('entry-modal');
        const modalBody = document.getElementById('modal-body');
        const closeEntryButton = document.getElementById('close-entry-button');
        const helpButton = document.getElementById('help-button');
        const helpModal = document.getElementById('help-modal');
        const closeHelpButton = document.getElementById('close-help-button');

        function resetApplication() {
            input.value = '';
            resultsContainer.innerHTML = '';
            resultsInfoText.textContent = '';
            exportLink.style.display = 'none';
            loadMoreContainer.style.display = 'none';

            // Reset zmiennych
            allDisplayedHits = [];
            loadedIds.clear();
            pendingBuffer = [];
            serverOffset = 0;
            isEndOfData = false;
            estimatedTotalHits = 0;
            lastQuery = "";

            input.focus();
        }

        // G≈Ç√≥wna funkcja sterujƒÖca procesem
        async function handleSearchOrLoadMore(isNewSearch = true) {
            const query = input.value;
            if (!query) return;

            if (isNewSearch) {
                lastQuery = query;
                serverOffset = 0;
                allDisplayedHits = [];
                loadedIds.clear();
                pendingBuffer = [];
                isEndOfData = false;

                resultsContainer.innerHTML = '';
                resultsInfoText.textContent = 'Wyszukiwanie...';
                exportLink.style.display = 'none';
                loadMoreContainer.style.display = 'none';
            } else {
                loadMoreButton.textContent = "≈Åadowanie...";
                loadMoreButton.disabled = true;
            }

            try {
                // Uzupe≈Çnianie bufora, je≈õli brakuje w nim element√≥w
                // powinno byƒá co najmniej DISPLAY_BATCH_SIZE element√≥w do pokazania
                // chyba, ≈ºe dane siƒô sko≈Ñczy≈Çy (isEndOfData)
                while (pendingBuffer.length < DISPLAY_BATCH_SIZE && !isEndOfData) {
                    await fetchNextBatchFromApi();
                }

                // Pobieranie z bufora
                const hitsToDisplay = pendingBuffer.splice(0, DISPLAY_BATCH_SIZE);

                if (hitsToDisplay.length > 0) {
                    renderHits(hitsToDisplay);
                    allDisplayedHits = [...allDisplayedHits, ...hitsToDisplay];
                } else if (isNewSearch) {
                    resultsContainer.innerHTML = '<p>Brak wynik√≥w.</p>';
                }

                updateUIStats();

            } catch (error) {
                resultsInfoText.textContent = 'B≈ÇƒÖd podczas pobierania wynik√≥w.';
                console.error('B≈ÇƒÖd:', error);
            } finally {
                loadMoreButton.textContent = "Za≈Çaduj wiƒôcej wynik√≥w";
                loadMoreButton.disabled = false;
            }
        }

        // Funkcja pomocnicza: pobiera surowe dane z API i ≈Çaduje unikaty do bufora
        async function fetchNextBatchFromApi() {
            const params = new URLSearchParams({
                q: lastQuery,
                limit: FETCH_SIZE,
                offset: serverOffset
            });

            const response = await fetch(`search?${params}`);
            const data = await response.json();

            estimatedTotalHits = data.estimatedTotalHits;
            const receivedHits = data.hits || [];

            // Weryfikacja czy to koniec danych na serwerze
            // Je≈õli przysz≈Ço mniej ni≈º powinno, to znaczy ≈ºe wiƒôcej nie ma
            if (receivedHits.length < FETCH_SIZE) {
                isEndOfData = true;
            }

            // Przesuniƒôcie offsetu serwera o tyle, ile otrzymano (niezale≈ºnie od duplikat√≥w)
            serverOffset += receivedHits.length;

            // Filtrowanie duplikat√≥w
            const newUniqueHits = receivedHits.filter(hit => !loadedIds.has(hit.id));

            // Unikalne ID do zbioru i hity do bufora
            newUniqueHits.forEach(hit => {
                loadedIds.add(hit.id);
                pendingBuffer.push(hit);
            });

            // Aktualizacja czasu (opcjonalnie mo≈ºna sumowaƒá, tu z ostatniego requestu)
            window.lastProcessingTime = data.processingTimeMs;
        }

        function updateUIStats() {
            const timeMs = window.lastProcessingTime || 0;
            resultsInfoText.textContent = `Wy≈õwietlono ${allDisplayedHits.length} z ok. ${estimatedTotalHits} wynik√≥w.`;

            if (allDisplayedHits.length > 0) {
                exportLink.style.display = 'inline-block';
            }

            // Przycisk widoczny, je≈õli co≈õ jest w buforze lub odczytywanie jeszcze nie dotar≈Ço do ko≈Ñca danych na serwerze
            if (pendingBuffer.length > 0 || !isEndOfData) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        function renderHits(hits) {
            hits.forEach(hit => {
                const item = document.createElement('div');
                item.className = 'result-item';
                let classHtml = '';
                if (hit.class) {
                    classHtml = `<div class="typy-container">klasa: <span class="typy-tag">${hit.class}</span></div>`;
                }
                item.innerHTML = `
                    <h3 class="entry-nazwa-link" data-id="${hit.id}">${hit.label}</h3>
                    ${classHtml}
                    <p class="smallinfo">RankingScore: ${(hit._rankingScore).toFixed(2)}</p>
                    <p>${hit._formatted.description}</p>
                `;
                resultsContainer.appendChild(item);
            });
        }

        // Obs≈Çuga formularza (Nowe wyszukiwanie)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            handleSearchOrLoadMore(true);
        });

        // Obs≈Çuga przycisku "Za≈Çaduj wiƒôcej"
        loadMoreButton.addEventListener('click', () => {
            handleSearchOrLoadMore(false);
        });

        async function openModal(entryId) {
            try {
                const response = await fetch(`entry/${entryId}`);
                if (!response.ok) { throw new Error('Nie mo≈ºna za≈Çadowaƒá danych.'); }
                const entry = await response.json();

                let classHtml = entry.class ? `<div class="typy-container">klasa: <span class="typy-tag">${entry.class}</span></div>` : '';
                let linkHtml = entry.link ? `<p class="info">Link: <a href="${entry.link}" target="_blank">${entry.link}</a></p>` : '';
                let geoHtml = entry.geo ? `<p class="info">wsp√≥≈Çrzƒôdne: ${entry.geo}</p>` : '';
                let propertyHtml = entry.property ?
                    `<h4 style="margin-top: 15px; margin-bottom: 5px;">W≈Ça≈õciwo≈õci:</h4><p class="modal-text-content">${entry.property}</p>` : '';

                modalBody.innerHTML = `
                    <h2>${entry.label}</h2>
                    ${entry.id ? `<p class="info">ID: ${entry.id}</p>` : ''}
                    ${classHtml}
                    ${linkHtml}
                    ${geoHtml}
                    <p class="modal-text-content">${entry.description}</p>
                    ${propertyHtml}
                `;
                modal.style.display = 'block';
            } catch (error) {
                modalBody.innerHTML = `<p style="color: red;">${error.message}</p>`;
                modal.style.display = 'block';
            }
        }

        function closeEntryModal() {
            modal.style.display = 'none';
            modalBody.innerHTML = '';
        }

        function exportToCSV() {
            if (allDisplayedHits.length === 0) return;

            const escapeCSV = (str) => {
                if (str === null || str === undefined) return '""';
                let result = String(str).replace(/"/g, '""');
                return `"${result}"`;
            };

            const headers = '"label","link","description"';
            const rows = allDisplayedHits.map(hit => {
                const label = escapeCSV(hit.label);
                const link = escapeCSV(hit.link);
                const desc = escapeCSV(hit.description || "");
                return [label, link, desc].join(',');
            });

            const csvString = "\uFEFF" + [headers, ...rows].join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'wikihum_export.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        resultsContainer.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('entry-nazwa-link')) {
                e.preventDefault();
                openModal(e.target.dataset.id);
            }
        });

        resetButton.addEventListener('click', resetApplication);
        closeEntryButton.addEventListener('click', closeEntryModal);

        helpButton.addEventListener('click', () => helpModal.style.display = 'block');
        closeHelpButton.addEventListener('click', () => helpModal.style.display = 'none');

        exportLink.addEventListener('click', (e) => {
            e.preventDefault();
            exportToCSV();
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) closeEntryModal();
            if (e.target === helpModal) helpModal.style.display = 'none';
        });
    </script>
</body>
</html>
